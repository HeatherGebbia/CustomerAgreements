@model CustomerAgreements.Models.Question

@{
    var q = Model;
    var agreement = ViewData["Agreement"] as CustomerAgreements.Models.Agreement;
    var existingAnswers = agreement?.Answers?.Where(a => a.QuestionID == q.QuestionID).ToList() ?? new List<CustomerAgreements.Models.Answer>();
    var existingAnswer = existingAnswers.FirstOrDefault();
}

<div class="mb-2">
    @switch (q.AnswerType)
    {
        case "Single-line Textbox":
            <input type="text" name="question_@q.QuestionID" value="@existingAnswer?.Text" class="form-control w-75" @(q.IsRequired ? "required" : null) />
            @if (q.IsRequired)
            {
                <div class="required-message">Required</div>
            }
            break;

        case "Multi-line Textbox":
            <textarea class="form-control w-75" name="question_@q.QuestionID" rows="3" @(q.IsRequired ? "required" : null)>@existingAnswer?.Text</textarea>
            @if (q.IsRequired)
            {
                <div class="required-message">Required</div>
            }
            break;

        case "Radio Button List":
            <div class="d-flex flex-wrap gap-0 align-items-baseline">
                @foreach (var ql in q.QuestionLists.OrderBy(ql => ql.SortOrder))
                {
                    var checkedAttr = existingAnswers.Any(a => a.QuestionListID == ql.QuestionListID) ? "checked" : null;
                    <div class="form-check form-check-inline">
                        <input type="radio"
                               class="form-check-input"
                               name="question_@q.QuestionID"
                               id="option_@ql.QuestionListID"
                               value="@ql.ListValue"
                               @checkedAttr
                               @(q.IsRequired ? "required" : null)
                               data-conditional="@ql.Conditional.ToString().ToLower()"
                               data-dependentid="dependent_@ql.QuestionListID" />

                        <label class="form-check-label" for="option_@ql.QuestionListID">
                            @ql.ListValue
                        </label>
                    </div>                    
                }
            </div>
            @if (q.IsRequired)
            {
                <div class="required-message">Required</div>
            }

            <!-- Render dependents, if any -->
            @foreach (var ql in q.QuestionLists.Where(ql => ql.Conditional))
            {
                var visible = existingAnswers.Any(a => a.QuestionListID == ql.QuestionListID);
                <div id="dependent_@ql.QuestionListID"
                     class="dependent-question mt-2 ms-4"
                     data-expanded="@(visible ? "true" : "false")"
                     style="display:@(visible ? "block" : "none");">
                    @foreach (var dq in ql.DependentQuestions.OrderBy(dq => dq.SortOrder))
                    {
                        <partial name="_RenderDependentQuestionType"
                                 model="dq"
                                 view-data='new ViewDataDictionary(ViewData) { ["Agreement"] = agreement }' />
                    }
                </div>
            }

            break;

        case "Checkbox List":
            <div>
                @foreach (var ql in q.QuestionLists.OrderBy(ql => ql.SortOrder))
                {
                    var isChecked = existingAnswers.Any(a => a.QuestionListID == ql.QuestionListID) ? "checked" : null;
                    <div class="form-check mb-2">
                        <input type="checkbox"
                               class="form-check-input"
                               name="question_@q.QuestionID"
                               id="checkbox_@ql.QuestionListID"
                               value="@ql.ListValue"
                               @isChecked
                               @(q.IsRequired ? "required" : null)
                               data-conditional="@ql.Conditional.ToString().ToLower()"
                               data-dependentid="dependent_@ql.QuestionListID" />
                        <label class="form-check-label" for="checkbox_@ql.QuestionListID">
                            @ql.ListValue
                        </label>
                    </div>
                }
            </div>
            @if (q.IsRequired)
            {
                <div class="required-message">Required</div>
            }

            <!-- Render dependents, if any -->
            @foreach (var ql in q.QuestionLists.Where(ql => ql.Conditional))
            {
                var visible = existingAnswers.Any(a => a.QuestionListID == ql.QuestionListID);
                <div id="dependent_@ql.QuestionListID"
                     class="dependent-question mt-2 ms-4"
                     data-expanded="@(visible ? "true" : "false")"
                     style="display:@(visible ? "block" : "none");">
                    @foreach (var dq in ql.DependentQuestions.OrderBy(dq => dq.SortOrder))
                    {
                        <partial name="_RenderDependentQuestionType"
                                 model="dq"
                                 view-data='new ViewDataDictionary(ViewData) { ["Agreement"] = agreement }' />
                    }
                </div>
            }

            break;

        case "Drop Down List":
            <select name="question_@q.QuestionID" class="form-select w-75" @(q.IsRequired ? "required" : null)>
                <option value="">-- Select One --</option>
                @foreach (var ql in q.QuestionLists.OrderBy(ql => ql.SortOrder))
                {
                    var isSelected = existingAnswer?.QuestionListID == ql.QuestionListID;
                    <option value="@ql.ListValue"
                            selected="@(isSelected ? "selected" : null)"
                            data-conditional="@ql.Conditional.ToString().ToLower()"
                            data-dependentid="dependent_@ql.QuestionListID">
                        @ql.ListValue
                    </option>

                }                
            </select>
            @if (q.IsRequired)
            {
                <div class="required-message">Required</div>
            }

            <!-- Render dependents, if any -->
            @foreach (var ql in q.QuestionLists.Where(ql => ql.Conditional))
            {
                var visible = existingAnswers.Any(a => a.QuestionListID == ql.QuestionListID);
                <div id="dependent_@ql.QuestionListID"
                     class="dependent-question mt-2 ms-4"
                     data-expanded="@(visible ? "true" : "false")"
                     style="display:@(visible ? "block" : "none");">
                    @foreach (var dq in ql.DependentQuestions.OrderBy(dq => dq.SortOrder))
                    {
                        <partial name="_RenderDependentQuestionType"
                                 model="dq"
                                 view-data='new ViewDataDictionary(ViewData) { ["Agreement"] = agreement }' />
                    }
                </div>
            }
            break;

        case "Date":
            <input type="date" name="question_@q.QuestionID" value="@existingAnswer?.DateAnswer?.ToString("yyyy-MM-dd")" class="form-control w-25" @(q.IsRequired ? "required" : null) />
            @if (q.IsRequired)
            {
                <div class="required-message">Required</div>
            }
            break;

        case "Single Checkbox":
            var isCheckedSingle = string.Equals(existingAnswer?.Text, "true", StringComparison.OrdinalIgnoreCase);

            <div class="form-check">
                <input type="checkbox"
                       class="form-check-input"
                       id="question_@q.QuestionID"
                       name="question_@q.QuestionID"
                       value="true"
                       @(isCheckedSingle ? "checked" : null)
                       @(q.IsRequired ? "required" : null) />
            </div>
            @if (q.IsRequired)
            {
                <div class="required-message">Required</div>
            }
            break;

        default:
            <input type="text" name="question_@q.QuestionID" value="@existingAnswer?.Text" class="form-control w-75" @(q.IsRequired ? "required" : null) />
            break;
    }
</div>